import { connect, Connection } from "@planetscale/database";
// Only needed for deprecated wrapper
import { IntegrationHandler } from "@netlify/integrations";
import nodeFetch from "node-fetch";

if (!process.env.PLANETSCALE_HOST || !process.env.PLANETSCALE_PASSWORD || !process.env.PLANETSCALE_USERNAME) {
  console.error("Missing PlanetScale credentials. Make sure Netlify Planetscale integration is enabled.");
}

const connection = connect({
  host: process.env.PLANETSCALE_HOST,
  password: process.env.PLANETSCALE_PASSWORD,
  username: process.env.PLANETSCALE_USERNAME,
  fetch: typeof fetch === "undefined" ? nodeFetch : fetch,
});

export default connection;
 
// Deprecated
export interface PlanetScaleContext {
  planetscale: {
    connection: Connection;
  };
}

// Deprecated
export const withPlanetscale: IntegrationHandler<PlanetScaleContext> = (
  handler
) => {
  return async (event, context) => {
    return handler(event, { ...context, planetscale: { connection } });
  };
};


